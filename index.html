<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Ù‡Ø±ÙˆØ¨ Ø§Ù„ÙØ±Ø®Ø© ğŸ”</title>
<style>
  :root { --bg:#0e1013; --panel:#151922; --text:#e8eef7; --accent:#ffd166; --danger:#ff4d4f; --ok:#30d158;}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(#1a1f2a,#0e1013) fixed;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{display:flex;align-items:center;justify-content:center;min-height:100%;}
  canvas{background:linear-gradient(#8fd3ff,#dff4ff 60%,#a1e6a1); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); max-width:100%; height:auto;}
  .hud{
    position:fixed; inset:auto 0 16px 0; display:flex; justify-content:center; pointer-events:none;
  }
  .bar{
    display:flex; gap:12px; align-items:center; padding:8px 12px; border-radius:999px;
    background:rgba(0,0,0,.3); color:#fff; backdrop-filter:blur(6px); font-weight:600;
  }
  .lead{
    width:180px; height:10px; background:#222a; border-radius:999px; overflow:hidden; outline:1px solid #fff2;
  }
  .lead > i{ display:block; height:100%; width:50%; background:linear-gradient(90deg, var(--ok), var(--accent));}
  .pill{padding:6px 10px; background:#0008; border-radius:999px; font-weight:700}
  .overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,rgba(14,16,19,.85),rgba(14,16,19,.65));
    color:var(--text); text-align:center; padding:24px;
  }
  .card{
    width:min(92vw,680px); background:var(--panel); border:1px solid #ffffff18; border-radius:20px; padding:24px; box-shadow:0 10px 40px #0008;
  }
  h1{margin:.2em 0 .3em;font-size:2rem}
  h2{margin:.6em 0 .3em}
  .kbd{display:inline-block; padding:.25em .55em; border:1px solid #fff3; border-bottom-width:3px; border-radius:8px; background:#0006; font-weight:700}
  .btn{
    margin-top:14px; display:inline-block; padding:10px 16px; background:var(--accent); color:#272a2f; font-weight:800;
    border:none; border-radius:999px; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.35);
  }
  .btn:hover{filter:brightness(1.05)}
  .note{opacity:.8; font-size:.95rem}
</style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="960" height="540" aria-label="Ù„Ø¹Ø¨Ø© Ù‡Ø±ÙˆØ¨ Ø§Ù„ÙØ±Ø®Ø©"></canvas>
  </div>

  <div class="hud" aria-hidden="true">
    <div class="bar">
      <span>Ø§Ù„Ù…Ø³Ø§ÙØ©: <span id="score">0</span>Ù…</span>
      <span class="pill" id="levelName">Ø§Ù„Ù‚Ø±ÙŠØ©</span>
      <div class="lead" title="Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙØ±Ø®Ø© ÙˆØ§Ù„Ù‚Ø·">
        <i id="leadFill" style="width:50%"></i>
      </div>
      <span>ğŸŸ¡ <span id="corn">0</span></span>
    </div>
  </div>

  <div id="overlay" class="overlay">
    <div class="card">
      <h1>Ù‡Ø±ÙˆØ¨ Ø§Ù„ÙØ±Ø®Ø© ğŸ”</h1>
      <p>Ø³Ø§Ø¹Ø¯ Ø§Ù„ØºØ±Ø® Ø§Ù„Ø¯Ø¬Ø§Ø¬ ÙŠÙ‡Ø±Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø·! Ø§Ù‚ÙØ² ÙÙˆÙ‚ Ø§Ù„Ø¹ÙˆØ§Ø¦Ù‚ ÙˆØ§Ø¬Ù…Ø¹ Ø§Ù„Ø°Ø±Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¹Ù† Ø§Ù„Ù‚Ø·.</p>
      <h2>Ø§Ù„ØªØ­ÙƒÙ…</h2>
      <p><span class="kbd">Ù…Ø³Ø§ÙØ©</span> Ø£Ùˆ Ù„Ù…Ø³Ø©/Ù†Ù‚Ø±Ø© = Ù‚ÙØ²<br>
         <span class="kbd">P</span> Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª â€¢ <span class="kbd">R</span> Ø¥Ø¹Ø§Ø¯Ø©</p>
      <button class="btn" id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
      <p class="note">ØªÙ„Ù…ÙŠØ­: Ø¬Ù…Ø¹ Ø§Ù„Ø°Ø±Ø© ÙŠØ²ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ†Ùƒ ÙˆØ¨ÙŠÙ† Ø§Ù„Ù‚Ø·. Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù…Ø§Øª ØªÙ‚Ù„Ù„Ù‡Ø§. Ø¥Ø°Ø§ ÙˆØµÙ„Øª Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„ØµÙØ±â€¦ Ø§Ù„Ù‚Ø· ÙŠÙ…Ø³ÙƒÙƒ! ğŸ˜¼</p>
    </div>
  </div>

<script>
(() => {
  // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© =====
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  const W = canvas.width, H = canvas.height;
  const groundY = H - 82;
  const G = 1700;              // Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ© (px/s^2)
  const JUMP_V = -720;         // Ø³Ø±Ø¹Ø© Ø§Ù„Ù‚ÙØ² (px/s)
  const BASE_SPEED = 240;      // Ø³Ø±Ø¹Ø© Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (px/s)

  // Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
  let running = false, paused = false, gameOver = false;
  let last = 0;

  // Ø§Ù„Ø¹Ø§Ù„Ù…/Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
  const levels = [
    {name: "Ø§Ù„Ù‚Ø±ÙŠØ©", speedMul: 1.00, color:"#a1e6a1", sky:"#dff4ff"},
    {name: "Ø§Ù„Ù…Ø²Ø±Ø¹Ø©", speedMul: 1.18, color:"#93db8f", sky:"#d7f0ff"},
    {name: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", speedMul: 1.32, color:"#86d38a", sky:"#cfeaff"},
    {name: "Ø§Ù„Ù‚Ù„Ø¹Ø©", speedMul: 1.48, color:"#78ca82", sky:"#c7e3ff"},
  ];
  const gates = [0, 800, 2200, 4200]; // Ø£Ù…ØªØ§Ø± ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø±Ø­Ù„Ø©

  let world = {
    speed: BASE_SPEED,
    distance: 0, // Ø¨Ø§Ù„Ù…ØªØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ (Ù†Ø­Ùˆ px/240)
    levelIdx: 0,
    bgTick: 0
  };

  // Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø§Ù„ÙØ±Ø®Ø©)
  const player = {
    x: 160, y: groundY - 60, w: 60, h: 60,
    vy: 0, onGround: true, flapTimer: 0, // Ø¬Ù†Ø§Ø­ Ø³Ø­Ø±ÙŠ (ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ© Ù…Ø¤Ù‚ØªØ§Ù‹)
    jump() {
      if (this.onGround) {
        this.vy = JUMP_V;
        this.onGround = false;
      }
    }
  };

  // Ø§Ù„Ù‚Ø· Ø§Ù„Ù…Ø·Ø§Ø±Ø¯ (ÙŠØ­Ø³Ø¨ Ø¨Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙØ¹Ù„ÙŠØ© ÙƒÙ€ "lead")
  const cat = {
    w: 70, h: 55, y: groundY - 55,
    lead: 140, // Ø¨ÙƒØ³Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù‚Ø· ÙˆÙ…Ø±ÙƒØ² Ø§Ù„Ù„Ø§Ø¹Ø¨ (ÙƒÙ„Ù…Ø§ Ù‚Ù„ ØµØ§Ø± Ø£Ø®Ø·Ø±)
    approachRate: 14 // px/sec (ÙŠØ²ÙŠØ¯ Ù…Ø¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„)
  };

  // Ø¹ÙˆØ§Ø¦Ù‚ ÙˆØ¹Ù†Ø§ØµØ±
  const obstacles = [];
  const coins = [];
  const feathers = [];
  let spawnObsT = 0, spawnCoinT = 0, spawnFeatT = 5;

  // Ù†Ù‚Ø§Ø·/Ø¹Ø¯Ø§Ø¯Ø§Øª
  let cornCount = 0;

  // Ø¹Ù†Ø§ØµØ± HUD
  const scoreEl = document.getElementById('score');
  const levelNameEl = document.getElementById('levelName');
  const leadFill = document.getElementById('leadFill');
  const cornEl = document.getElementById('corn');
  const overlay = document.getElementById('overlay');
  const startBtn = document.getElementById('startBtn');

  // ===== Ø£Ø¯ÙˆØ§Øª =====
  function rand(a,b){return Math.random()*(b-a)+a}
  function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
  function aabb(ax,ay,aw,ah,bx,by,bw,bh){
    return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
  }

  function resetGame() {
    running = true; paused = false; gameOver = false; last = 0;
    world = { speed: BASE_SPEED, distance:0, levelIdx:0, bgTick:0 };
    player.x = 160; player.y = groundY-60; player.vy = 0; player.onGround = true; player.flapTimer = 0;
    cat.lead = 140;
    obstacles.length = 0; coins.length = 0; feathers.length = 0;
    spawnObsT = 0; spawnCoinT = 0; spawnFeatT = 6;
    cornCount = 0;
    overlay.style.display = 'none';
    leadFill.style.width = '50%';
    levelNameEl.textContent = levels[0].name;
    scoreEl.textContent = '0'; cornEl.textContent = '0';
  }

  function gameOverScreen(msg="Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! ğŸ±â€ğŸ‘¤") {
    running = false; gameOver = true;
    overlay.innerHTML = `
      <div class="card">
        <h1>${msg}</h1>
        <p>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©: <b>${Math.floor(world.distance)}</b> Ù…ØªØ± â€¢ Ø§Ù„Ø°Ø±Ø©: <b>${cornCount}</b></p>
        <button class="btn" id="restartBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨</button>
        <p class="note">Ù†ØµÙŠØ­Ø©: Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù‚ÙØ²Ø§ØªÙƒ ÙÙŠ ØªÙˆÙ‚ÙŠØªÙ Ø¯Ù‚ÙŠÙ‚ØŒ ÙˆØ§Ù„Ù’ØªÙ‚Ø· Ø§Ù„Ø±ÙŠØ´Ø© Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ© Ù…Ø¤Ù‚ØªÙ‹Ø§.</p>
      </div>`;
    overlay.style.display = 'flex';
    document.getElementById('restartBtn').onclick = () => resetGame();
  }

  // ===== Ø±Ø³Ù… Ø§Ù„Ø´Ø®ØµÙŠØ§Øª Ø¨Ø´ÙƒÙ„ ÙƒØ±ØªÙˆÙ†ÙŠ Ø¨Ø³ÙŠØ· =====
  function drawChicken(x,y,w,h){
    // Ø¬Ø³Ù…
    ctx.fillStyle = "#fffaf0";
    roundRect(x,y,w,h,14,true,false);

    // Ø¬Ù†Ø§Ø­ ØªØ²ÙŠÙŠÙ†ÙŠ
    ctx.fillStyle = "#ffe6a7";
    roundRect(x+10,y+18,w*0.55,h*0.42,10,true,false);

    // Ø¹ÙŠÙ†
    ctx.fillStyle="#222";
    ctx.beginPath(); ctx.arc(x+w-18,y+16,6,0,Math.PI*2); ctx.fill();

    // Ù…Ù†Ù‚Ø§Ø±
    ctx.fillStyle="#ff9f1c";
    ctx.beginPath();
    ctx.moveTo(x+w-8,y+h*0.45);
    ctx.lineTo(x+w+12,y+h*0.5);
    ctx.lineTo(x+w-8,y+h*0.55);
    ctx.closePath(); ctx.fill();

    // Ø£Ø±Ø¬Ù„
    ctx.strokeStyle="#ff9f1c"; ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(x+14,y+h); ctx.lineTo(x+14,y+h+10); ctx.moveTo(x+34,y+h); ctx.lineTo(x+34,y+h+10); ctx.stroke();

    // ØªØ£Ø«ÙŠØ± "Ø¬Ù†Ø§Ø­ Ø³Ø­Ø±ÙŠ" Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„
    if (player.flapTimer>0){
      ctx.globalAlpha=0.55;
      ctx.fillStyle="#b4f5ff";
      ctx.beginPath();
      ctx.ellipse(x+w*0.35,y+h*0.2,w*0.4,h*0.3,0,0,Math.PI*2);
      ctx.fill();
      ctx.globalAlpha=1;
    }
  }

  function drawCat(x,y,w,h){
    // Ø¬Ø³Ù…
    ctx.fillStyle="#3a3a45";
    roundRect(x,y,w,h,10,true,false);
    // Ø£Ø°Ù†Ø§Ù†
    ctx.fillStyle="#3a3a45";
    ctx.beginPath(); ctx.moveTo(x+10,y); ctx.lineTo(x+24,y-16); ctx.lineTo(x+30,y); ctx.closePath(); ctx.fill();
    ctx.beginPath(); ctx.moveTo(x+w-10,y); ctx.lineTo(x+w-24,y-16); ctx.lineTo(x+w-30,y); ctx.closePath(); ctx.fill();
    // Ø¹ÙŠÙ†Ø§Ù†
    ctx.fillStyle="#ffd166";
    ctx.beginPath(); ctx.arc(x+20,y+16,5,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x+w-20,y+16,5,0,Math.PI*2); ctx.fill();
    // ÙÙ…
    ctx.strokeStyle="#fff"; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(x+w/2-8,y+h-16); ctx.quadraticCurveTo(x+w/2,y+h-10,x+w/2+8,y+h-16); ctx.stroke();
  }

  function roundRect(x,y,w,h,r,fill,stroke){
    if (w<2*r) r=w/2; if (h<2*r) r=h/2;
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,  x+w,y+h, r);
    ctx.arcTo(x+w,y+h,x,  y+h,  r);
    ctx.arcTo(x,  y+h,x,  y,    r);
    ctx.arcTo(x,  y,  x+w,y,    r);
    ctx.closePath();
    if(fill) ctx.fill();
    if(stroke) ctx.stroke();
  }

  // ===== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© =====
  function updateLevel(){
    const d = world.distance;
    let idx = 0;
    if (d >= gates[3]) idx = 3;
    else if (d >= gates[2]) idx = 2;
    else if (d >= gates[1]) idx = 1;
    if (idx !== world.levelIdx){
      world.levelIdx = idx;
      levelNameEl.textContent = levels[idx].name;
    }
    // Ø³Ø±Ø¹Ø© Ø§Ù„Ø¹Ø§Ù„Ù… ÙˆÙˆØªÙŠØ±Ø© Ø§Ù‚ØªØ±Ø§Ø¨ Ø§Ù„Ù‚Ø· ØªØ²Ø¯Ø§Ø¯ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹
    const lv = levels[world.levelIdx];
    world.speed = BASE_SPEED * lv.speedMul;
    cat.approachRate = 14 * lv.speedMul;
  }

  // ===== ØªÙˆÙ„ÙŠØ¯ Ø¹Ù†Ø§ØµØ± =====
  function spawnObstacle(){
    // Ø«Ù„Ø§Ø«Ø© Ø£Ù†Ù…Ø§Ø·: ØµÙ†Ø¯ÙˆÙ‚ØŒ Ø´ÙˆÙƒØ©ØŒ Ø¨Ø±ÙƒØ©
    const type = Math.random();
    let w=40,h=40,y=groundY-40, color="#6b4f3a";
    if (type < 0.33){ // ØµÙ†Ø¯ÙˆÙ‚
      w = 48; h = 46; y=groundY-h; color="#7b523c";
    } else if (type < 0.66){ // Ø´ÙˆÙƒØ©
      w = 40; h = 46; y=groundY-h; color="#9b1c1c";
    } else { // Ø¨Ø±ÙƒØ©
      w = 78; h = 20; y=groundY-h+6; color="#2aa1ff";
    }
    obstacles.push({x: W+40, y, w, h, color, type: (type<0.33?'box':type<0.66?'spike':'pool')});
  }

  function spawnCoin(){
    const y = groundY - (Math.random()<0.5? 120 : 70);
    coins.push({x: W+30, y, r:10, taken:false, val:1});
  }

  function spawnFeather(){
    const y = groundY - 140;
    feathers.push({x: W+40, y, r:12, taken:false, time:2.2}); // 2.2 Ø«Ø§Ù†ÙŠØ© Ø·ÙŠØ±Ø§Ù† Ø®ÙÙŠÙ
  }

  // ===== ØªØ­Ø¯ÙŠØ« ÙˆØ±Ø³Ù… Ø§Ù„Ø®Ù„ÙÙŠØ© =====
  function drawBackground(dt){
    const lv = levels[world.levelIdx];
    // Ø³Ù…Ø§Ø¡
    const grad = ctx.createLinearGradient(0,0,0,H*0.7);
    grad.addColorStop(0, "#8fd3ff");
    grad.addColorStop(1, lv.sky);
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,W,H);

    // ØªÙ„Ø§Ù„ Ù…ØªØ­Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø©
    world.bgTick += dt * world.speed * 0.25;
    for (let i=0;i<3;i++){
      const yBase = groundY - 80 - i*24;
      ctx.fillStyle = `rgba(60, ${120+i*30}, 80, ${0.18+i*0.07})`;
      ctx.beginPath();
      const offset = (world.bgTick*(0.4+i*0.25)) % (W);
      ctx.moveTo(0, groundY);
      for (let x=-W;x<=W*2;x+=40){
        const X = x - offset;
        const Y = yBase + Math.sin((x+i*50)*0.01)*20;
        ctx.lineTo(X,Y);
      }
      ctx.lineTo(W,groundY); ctx.closePath(); ctx.fill();
    }

    // Ø£Ø±Ø¶ÙŠØ©
    ctx.fillStyle = lv.color;
    ctx.fillRect(0,groundY,W,H-groundY);
    // Ø®Ø·ÙˆØ· Ø¹Ø´Ø¨ Ø¨Ø³ÙŠØ·Ø©
    ctx.strokeStyle="rgba(0,0,0,.08)"; ctx.lineWidth=2;
    for(let i=0;i<W;i+=24){
      ctx.beginPath(); ctx.moveTo((i - (world.bgTick*1.2)%24), groundY);
      ctx.lineTo((i - (world.bgTick*1.2)%24)+8, groundY-6); ctx.stroke();
    }
  }

  // ===== Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© =====
  function update(dt){
    if (!running || paused) return;

    // ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨
    const effG = player.flapTimer>0 ? G * 0.55 : G;
    player.vy += effG * dt;
    player.y += player.vy * dt;
    if (player.y + player.h >= groundY){
      player.y = groundY - player.h; player.vy = 0; player.onGround = true;
    }
    if (player.flapTimer>0){
      player.flapTimer -= dt;
      if (player.flapTimer < 0) player.flapTimer = 0;
    }

    // ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ø§Ù„Ù…
    updateLevel();
    const vx = world.speed * dt;
    world.distance += (world.speed * dt) / 2.4 * 0.01 * 100; // ØªÙ‚Ø±ÙŠØ¨ Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø£Ù…ØªØ§Ø±
    scoreEl.textContent = Math.floor(world.distance);

    // ØªÙˆÙ„ÙŠØ¯ Ø¹Ù†Ø§ØµØ±
    spawnObsT -= dt;
    spawnCoinT -= dt;
    spawnFeatT -= dt;

    if (spawnObsT <= 0){
      spawnObstacle();
      const baseGap = clamp(1.05 - world.levelIdx*0.12, 0.6, 1.05);
      spawnObsT = rand(baseGap, baseGap+0.8);
    }
    if (spawnCoinT <= 0){
      spawnCoin();
      spawnCoinT = rand(1.2, 2.0);
    }
    if (spawnFeatT <= 0){
      if (Math.random() < 0.65) spawnFeather();
      spawnFeatT = rand(7, 11);
    }

    // ØªØ­Ø±ÙŠÙƒ ÙˆØ±Ø³Ù…
    drawBackground(dt);

    // Ø¹ÙˆØ§Ø¦Ù‚
    for (let i=obstacles.length-1;i>=0;i--){
      const o = obstacles[i];
      o.x -= world.speed * dt;
      // Ø±Ø³Ù…
      ctx.fillStyle = o.color;
      if (o.type==='spike'){
        // Ù…Ø«Ù„Ø« Ø´ÙˆÙƒ
        ctx.beginPath();
        ctx.moveTo(o.x,o.y+o.h); ctx.lineTo(o.x+o.w/2,o.y); ctx.lineTo(o.x+o.w,o.y+o.h); ctx.closePath(); ctx.fill();
      } else {
        roundRect(o.x,o.y,o.w,o.h,8,true,false);
        if (o.type==='pool'){
          ctx.fillStyle = "rgba(255,255,255,.2)";
          ctx.fillRect(o.x+6,o.y+4,o.w-12,4);
        }
      }
      // ØªØµØ§Ø¯Ù…
      if (aabb(player.x,player.y,player.w,player.h,o.x,o.y,o.w,o.h)){
        // ÙÙ‚Ø¯Ø§Ù† Ù…Ø³Ø§ÙØ© Ø­Ø§Ø¯ ÙˆÙ„ÙŠØ³ Ù…ÙˆØª ÙÙˆØ±ÙŠ
        cat.lead -= 90;
        obstacles.splice(i,1);
      }
      if (o.x+o.w < -20) obstacles.splice(i,1);
    }

    // Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø°Ø±Ø©
    for (let i=coins.length-1;i>=0;i--){
      const c = coins[i];
      c.x -= world.speed * dt;
      // Ø±Ø³Ù…
      ctx.fillStyle="#ffd166";
      ctx.beginPath(); ctx.ellipse(c.x,c.y, c.r*1.15, c.r, 0, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle="rgba(255,255,255,.6)"; ctx.lineWidth=2; ctx.stroke();
      // ØªØµØ§Ø¯Ù…
      if (!c.taken && aabb(player.x,player.y,player.w,player.h, c.x-c.r,c.y-c.r, c.r*2,c.r*2)){
        c.taken = true; cornCount += c.val; cat.lead += 36;
        coins.splice(i,1);
      }
      if (c.x < -30) coins.splice(i,1);
    }
    cornEl.textContent = cornCount;

    // Ø±ÙŠØ´Ø© (Ø¬Ù†Ø§Ø­ Ø³Ø­Ø±ÙŠ)
    for (let i=feathers.length-1;i>=0;i--){
      const f = feathers[i];
      f.x -= world.speed * dt;
      // Ø±Ø³Ù…
      ctx.save();
      ctx.translate(f.x, f.y);
      ctx.rotate(Math.sin((performance.now()/400)+i)*0.2);
      ctx.fillStyle="#b4f5ff";
      ctx.beginPath();
      ctx.moveTo(0,0); ctx.quadraticCurveTo(22,-8, 28,0); ctx.quadraticCurveTo(22,12, 0,10); ctx.closePath(); ctx.fill();
      ctx.restore();
      // ØªØµØ§Ø¯Ù…
      if (!f.taken && aabb(player.x,player.y,player.w,player.h, f.x-16,f.y-10, 32,20)){
        f.taken = true; player.flapTimer = f.time; cat.lead += 24;
        feathers.splice(i,1);
      }
      if (f.x < -40) feathers.splice(i,1);
    }

    // Ø§Ù„Ù‚Ø· ÙŠÙ‚ØªØ±Ø¨ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹
    cat.lead -= cat.approachRate * dt;
    cat.lead = clamp(cat.lead, 0, 260);

    // Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆØ§Ù„Ù‚Ø·
    drawChicken(player.x, player.y, player.w, player.h);
    const catX = player.x - cat.lead - (cat.w - player.w)/2;
    drawCat(catX, cat.y, cat.w, cat.h);

    // Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø³Ø§ÙØ©
    const percent = (cat.lead/260)*100;
    leadFill.style.width = percent.toFixed(1) + '%';
    leadFill.style.background = (percent<25) ? 'linear-gradient(90deg, var(--danger), #ff8d6c)' :
                                 (percent<50) ? 'linear-gradient(90deg, #ffb020, #ffd166)' :
                                                'linear-gradient(90deg, var(--ok), var(--accent))';

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ
    if (cat.lead <= 0){
      gameOverScreen("Ø£Ù…Ø³ÙƒÙƒ Ø§Ù„Ù‚Ø·! ğŸ˜¿");
    }
  }

  function loop(ts){
    if (!running){ last = ts; requestAnimationFrame(loop); return; }
    const dt = Math.min(0.032, (ts - last)/1000 || 0); // Ø³Ù‚Ù 32ms
    last = ts;
    if (!paused) update(dt);
    requestAnimationFrame(loop);
  }

  // ===== Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… =====
  function tryJump(){
    if (!running || paused) return;
    player.jump();
  }

  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space' || e.code === 'ArrowUp'){ e.preventDefault(); tryJump(); }
    else if (e.code === 'KeyP'){ paused = !paused; }
    else if (e.code === 'KeyR'){ resetGame(); }
  }, {passive:false});

  // Ù„Ù…Ø³/Ù†Ù‚Ø± Ù„Ù„Ù‚ÙØ²
  ['pointerdown','touchstart'].forEach(ev => {
    canvas.addEventListener(ev, () => {
      if (!running && !gameOver) return;
      tryJump();
    }, {passive:true});
  });

  // Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
  startBtn.addEventListener('click', resetGame);

  // Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ù„Ù‚Ø©
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
