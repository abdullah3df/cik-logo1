<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù‡Ø±ÙˆØ¨ Ø§Ù„ÙØ±Ø®Ø© â€” Ù†Ø³Ø®Ø© Sprites Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
<style>
  :root{--bg:#0e1013;--panel:#151922;--text:#e8eef7;--accent:#ffd166;--danger:#ff4d4f;--ok:#30d158}
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:linear-gradient(#1a1f2a,#0e1013);font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{display:flex;align-items:center;justify-content:center;min-height:100%}
  canvas{background:linear-gradient(#8fd3ff,#dff4ff 60%,#a1e6a1);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);max-width:100%;height:auto}
  .hud{position:fixed;inset:auto 0 10px 0;display:flex;justify-content:center;pointer-events:none}
  .bar{display:flex;gap:12px;align-items:center;padding:8px 12px;border-radius:999px;background:#0006;color:#fff;backdrop-filter:blur(6px);font-weight:700}
  .lead{width:180px;height:10px;background:#222a;border-radius:999px;overflow:hidden;outline:1px solid #fff2}
  .lead>i{display:block;height:100%;width:50%;background:linear-gradient(90deg,var(--ok),var(--accent))}
  .pill{padding:6px 10px;background:#0008;border-radius:999px}
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(14,16,19,.85),rgba(14,16,19,.6));color:var(--text);text-align:center;padding:20px}
  .card{width:min(92vw,720px);background:var(--panel);border:1px solid #ffffff18;border-radius:20px;padding:20px;box-shadow:0 10px 40px #0008}
  h1{margin:.2em 0 .3em;font-size:1.9rem} .kbd{padding:.25em .55em;border:1px solid #fff3;border-bottom-width:3px;border-radius:8px;background:#0006;font-weight:800}
  .btn{margin-top:10px;display:inline-block;padding:10px 16px;background:var(--accent);color:#272a2f;font-weight:900;border:none;border-radius:999px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.35)}
  .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px}
  .uploader{display:flex;align-items:center;gap:8px;background:#0c0f15;border:1px solid #ffffff22;color:#cfe3ff;border-radius:12px;padding:8px 10px}
  label{font-size:.9rem;opacity:.9}
  input[type="number"]{width:72px;background:#0c0f15;color:#fff;border:1px solid #ffffff22;border-radius:8px;padding:6px}
  input[type="file"]{accent-color:#ffd166}
</style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="960" height="540" aria-label="Ù„Ø¹Ø¨Ø© Ù‡Ø±ÙˆØ¨ Ø§Ù„ÙØ±Ø®Ø©"></canvas>
  </div>

  <div class="hud" aria-hidden="true">
    <div class="bar">
      <span>Ø§Ù„Ù…Ø³Ø§ÙØ©: <span id="score">0</span>Ù…</span>
      <span class="pill" id="levelName">Ø§Ù„Ù‚Ø±ÙŠØ©</span>
      <div class="lead" title="Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¹Ù† Ø§Ù„Ù‚Ø·"><i id="leadFill"></i></div>
      <span>ğŸŸ¡ <span id="corn">0</span></span>
    </div>
  </div>

  <div id="overlay" class="overlay">
    <div class="card">
      <h1>Ù‡Ø±ÙˆØ¨ Ø§Ù„ÙØ±Ø®Ø© ğŸ” â€” Ø±Ø³ÙˆÙ…Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠØ© (PNG Sprites)</h1>
      <p>Ø§Ø±ÙØ¹ Sprite Ø§Ù„ÙØ±Ø®Ø© ÙˆØ§Ù„Ù‚Ø· (PNG Ø´ÙØ§Ù) Ø£Ùˆ Ø¶Ø¹Ù‡Ù…Ø§ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ <b>assets/chicken_run.png</b> Ùˆ <b>assets/cat_run.png</b>.</p>

      <div class="row">
        <div class="uploader">
          <label>ğŸ” ÙØ±Ø®Ø©:</label>
          <input id="chFile" type="file" accept="image/png,image/webp" />
          <label>Ø¥Ø·Ø§Ø±Ø§Øª</label><input id="chFrames" type="number" min="1" value="8" />
          <label>FPS</label><input id="chFps" type="number" min="1" value="10" />
        </div>
        <div class="uploader">
          <label>ğŸ˜¼ Ù‚Ø·:</label>
          <input id="catFile" type="file" accept="image/png,image/webp" />
          <label>Ø¥Ø·Ø§Ø±Ø§Øª</label><input id="catFrames" type="number" min="1" value="6" />
          <label>FPS</label><input id="catFps" type="number" min="1" value="12" />
        </div>
      </div>

      <p style="margin-top:10px">Ø§Ù„ØªØ­ÙƒÙ…: <span class="kbd">Ù…Ø³Ø§ÙØ©</span>/<span class="kbd">Ù†Ù‚Ø±Ø©</span> = Ù‚ÙØ² â€” <span class="kbd">P</span> Ø¥ÙŠÙ‚Ø§Ù â€” <span class="kbd">R</span> Ø¥Ø¹Ø§Ø¯Ø©</p>
      <button class="btn" id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
      <p style="opacity:.8">Ù†ØµÙŠØ­Ø©: Ø§Ø®ØªØ± Sprite ÙÙŠÙ‡ ÙˆØ¶Ø¹ÙŠØ© <b>Ø±ÙƒØ¶ Ø¬Ø§Ù†Ø¨ÙŠ</b>ØŒ Ø¨Ù…Ø³ØªØ·ÙŠÙ„ Ø£ÙÙ‚ÙŠ ÙˆØ§Ø­Ø¯ Ù…Ù‚Ø³ÙˆÙ… Ù„Ø¥Ø·Ø§Ø±Ø§Øª Ù…ØªØ³Ø§ÙˆÙŠØ©.</p>
    </div>
  </div>

<script>
(() => {
  // ===== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ù…Ø§Ø´
  const canvas = document.getElementById('game'); const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height; const groundY = H - 82;
  const G = 1700, JUMP_V = -720, BASE_SPEED = 240;

  // HUD
  const scoreEl = document.getElementById('score'), levelNameEl = document.getElementById('levelName');
  const leadFill = document.getElementById('leadFill'), cornEl = document.getElementById('corn');
  const overlay = document.getElementById('overlay'), startBtn = document.getElementById('startBtn');

  // Ø±ÙØ¹ Ù…Ù„ÙØ§Øª
  const chFile = document.getElementById('chFile'), catFile = document.getElementById('catFile');
  const chFramesEl = document.getElementById('chFrames'), catFramesEl = document.getElementById('catFrames');
  const chFpsEl = document.getElementById('chFps'), catFpsEl = document.getElementById('catFps');

  // Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø©
  let running=false, paused=false, gameOver=false, last=0;
  const levels=[{name:"Ø§Ù„Ù‚Ø±ÙŠØ©",mul:1,sky:"#dff4ff",grass:"#a1e6a1"},{name:"Ø§Ù„Ù…Ø²Ø±Ø¹Ø©",mul:1.18,sky:"#d7f0ff",grass:"#93db8f"},{name:"Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",mul:1.32,sky:"#cfeaff",grass:"#86d38a"},{name:"Ø§Ù„Ù‚Ù„Ø¹Ø©",mul:1.48,sky:"#c7e3ff",grass:"#78ca82"}];
  const gates=[0,800,2200,4200];
  let world={speed:BASE_SPEED,distance:0,idx:0,bgTick:0};

  // Ø§Ù„Ù„Ø§Ø¹Ø¨/Ø§Ù„Ù‚Ø·
  const player={x:180,y:groundY-64,w:72,h:64,vy:0,onGround:true,flap:0};
  const cat={w:80,h:64,y:groundY-64,lead:140,approach:14};

  // Sprites (Ø¯Ø¹Ù… SpriteSheet Ø£ÙÙ‚ÙŠ Ø¨Ø¥Ø·Ø§Ø±Ø§Øª Ù…ØªØ³Ø§ÙˆÙŠØ©)
  function makeSprite(){
    return {img:new Image(), ready:false, frames:8, fps:10, frame:0, acc:0,
      draw(x,y,w,h,dt){
        if(!this.ready){ // Ø¸Ù„ Ø¨Ø³ÙŠØ· Ù„Ø­Ø¯ Ù…Ø§ ÙŠØ¬Ù‡Ø²
          ctx.fillStyle="#0003"; ctx.fillRect(x+8,y+h-6,w-16,4); return;
        }
        const fw = this.img.width/this.frames, fh = this.img.height;
        this.acc += dt; const step = 1/Math.max(1,this.fps);
        while(this.acc>=step){ this.acc-=step; this.frame=(this.frame+1)%this.frames; }
        ctx.drawImage(this.img, fw*this.frame, 0, fw, fh, x, y, w, h);
      }
    }
  }
  const chicken = makeSprite();
  const catSprite = makeSprite();

  // ØªØ­Ù…ÙŠÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ù† Ù…Ø¬Ù„Ø¯ assets Ø¥Ù† ÙˆØ¬Ø¯
  function tryLoadDefault(){
    const load = (spr, src) => new Promise(res=>{
      spr.img.onload=()=>{spr.ready=true; res(true)}; spr.img.onerror=()=>res(false); spr.img.src=src;
    });
    Promise.all([
      load(chicken, "assets/chicken_run.png"),
      load(catSprite,"assets/cat_run.png")
    ]).then(()=>{ /* ØªØ¬Ø§Ù‡Ù„ Ù„Ùˆ Ù…Ø§ ÙˆØ¬Ø¯ */ });
  }
  tryLoadDefault();

  // Ø±ÙØ¹ ÙŠØ¯ÙˆÙŠ
  function bindFile(input, spr, framesEl, fpsEl){
    input.addEventListener('change', ()=>{
      const f = input.files?.[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      spr.img = new Image();
      spr.img.onload=()=>{ spr.ready=true; spr.frames = +framesEl.value||8; spr.fps = +fpsEl.value||10; spr.frame=0; spr.acc=0; };
      spr.img.src = url;
    });
    framesEl.addEventListener('change',()=>{ spr.frames=+framesEl.value||spr.frames; });
    fpsEl.addEventListener('change',()=>{ spr.fps=+fpsEl.value||spr.fps; });
  }
  bindFile(chFile, chicken, chFramesEl, chFpsEl);
  bindFile(catFile, catSprite, catFramesEl, catFpsEl);

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù„Ø¹Ø¨Ø©
  const obstacles=[], coins=[], feathers=[];
  let spawnObsT=0, spawnCoinT=0, spawnFeatT=5, corn=0;

  function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
  function aabb(ax,ay,aw,ah,bx,by,bw,bh){return ax<bx+bw&&ax+aw>bx&&ay<by+bh&&ay+ah>by;}

  function reset(){
    running=true; paused=false; gameOver=false; last=0;
    world={speed:BASE_SPEED,distance:0,idx:0,bgTick:0};
    player.x=180; player.y=groundY-64; player.vy=0; player.onGround=true; player.flap=0;
    cat.lead=140; obstacles.length=0; coins.length=0; feathers.length=0;
    spawnObsT=0; spawnCoinT=0; spawnFeatT=6; corn=0;
    overlay.style.display='none'; leadFill.style.width='50%'; levelNameEl.textContent=levels[0].name;
    scoreEl.textContent='0'; cornEl.textContent='0';
  }

  function gameOverScreen(msg){
    running=false; gameOver=true;
    overlay.innerHTML = `
      <div class="card">
        <h1>${msg}</h1>
        <p>Ø§Ù„Ù…Ø³Ø§ÙØ©: <b>${Math.floor(world.distance)}</b>Ù… â€¢ Ø§Ù„Ø°Ø±Ø©: <b>${corn}</b></p>
        <button class="btn" id="restartBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
        <p style="opacity:.8">Ø§Ø±ÙØ¹ Sprites Ø£ÙØ¶Ù„ Ù„Ùˆ Ø§Ø­ØªØ¬Øª â€” Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª = Ø¹Ø¯Ø¯ ØµÙˆØ± Ø§Ù„Ø±ÙƒØ¶ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙÙ‚ÙŠ.</p>
      </div>`;
    overlay.style.display='flex';
    document.getElementById('restartBtn').onclick=reset;
  }

  function updateLevel(){
    const d=world.distance;
    let idx=(d>=gates[3])?3:(d>=gates[2])?2:(d>=gates[1])?1:0;
    if(idx!==world.idx){world.idx=idx; levelNameEl.textContent=levels[idx].name;}
    world.speed = BASE_SPEED*levels[world.idx].mul;
    cat.approach = 14*levels[world.idx].mul;
  }

  function spawnObstacle(){
    const t=Math.random(); let w=46,h=46,y=groundY-46,color="#7b523c",type='box';
    if(t<.33){type='box'; w=52; h=48; y=groundY-h; color="#7b523c";}
    else if(t<.66){type='spike'; w=42; h=50; y=groundY-h; color="#9b1c1c";}
    else{type='pool'; w=84; h=22; y=groundY-h+6; color="#2aa1ff";}
    obstacles.push({x:W+40,y,w,h,color,type});
  }
  function spawnCoin(){ const y=groundY-(Math.random()<.5?120:70); coins.push({x:W+30,y,r:10}); }
  function spawnFeather(){ feathers.push({x:W+40,y:groundY-140,r:12,time:2.2}); }

  function bg(dt){
    const lv=levels[world.idx]; const grad=ctx.createLinearGradient(0,0,0,H*.7);
    grad.addColorStop(0,"#8fd3ff"); grad.addColorStop(1,lv.sky); ctx.fillStyle=grad; ctx.fillRect(0,0,W,H);
    world.bgTick+=dt*world.speed*.25;
    for(let i=0;i<3;i++){
      const yb=groundY-80-i*24; ctx.fillStyle=`rgba(60,${120+i*30},80,${.18+i*.07})`;
      ctx.beginPath(); const off=(world.bgTick*(.4+i*.25))%W; ctx.moveTo(0,groundY);
      for(let x=-W;x<=W*2;x+=40){ const X=x-off; const Y=yb+Math.sin((x+i*50)*.01)*20; ctx.lineTo(X,Y);}
      ctx.lineTo(W,groundY); ctx.closePath(); ctx.fill();
    }
    ctx.fillStyle=lv.grass; ctx.fillRect(0,groundY,W,H-groundY);
  }

  function update(dt){
    if(!running||paused) return;

    // ÙÙŠØ²ÙŠØ§Ø¡
    const effG = player.flap>0 ? G*.55 : G;
    player.vy += effG*dt; player.y += player.vy*dt;
    if(player.y+player.h>=groundY){player.y=groundY-player.h; player.vy=0; player.onGround=true;}
    if(player.flap>0){player.flap-=dt; if(player.flap<0) player.flap=0;}

    updateLevel();
    world.distance += (world.speed*dt)/2.4*0.01*100; scoreEl.textContent = Math.floor(world.distance);

    // ØªÙˆÙ„ÙŠØ¯
    spawnObsT-=dt; spawnCoinT-=dt; spawnFeatT-=dt;
    if(spawnObsT<=0){ spawnObstacle(); const baseGap= Math.max(.6, 1.05-world.idx*.12); spawnObsT = baseGap + Math.random()*.8; }
    if(spawnCoinT<=0){ spawnCoin(); spawnCoinT = 1.2 + Math.random()*.8; }
    if(spawnFeatT<=0){ if(Math.random()<.65) spawnFeather(); spawnFeatT = 7 + Math.random()*4; }

    // Ø±Ø³Ù…
    bg(dt);

    // Ø¹ÙˆØ§Ø¦Ù‚
    for(let i=obstacles.length-1;i>=0;i--){
      const o=obstacles[i]; o.x -= world.speed*dt;
      if(o.type==='spike'){ ctx.fillStyle=o.color; ctx.beginPath(); ctx.moveTo(o.x,o.y+o.h); ctx.lineTo(o.x+o.w/2,o.y); ctx.lineTo(o.x+o.w,o.y+o.h); ctx.closePath(); ctx.fill();}
      else { ctx.fillStyle=o.color; roundRect(o.x,o.y,o.w,o.h,8,true,false); if(o.type==='pool'){ctx.fillStyle="rgba(255,255,255,.2)"; ctx.fillRect(o.x+6,o.y+4,o.w-12,4);} }
      if(aabb(player.x,player.y,player.w,player.h,o.x,o.y,o.w,o.h)){ cat.lead -= 90; obstacles.splice(i,1); }
      if(o.x+o.w<-20) obstacles.splice(i,1);
    }
    // Ø°Ø±Ø©
    for(let i=coins.length-1;i>=0;i--){
      const c=coins[i]; c.x -= world.speed*dt;
      ctx.fillStyle="#ffd166"; ctx.beginPath(); ctx.ellipse(c.x,c.y,11.5,10,0,0,Math.PI*2); ctx.fill(); ctx.strokeStyle="rgba(255,255,255,.6)"; ctx.lineWidth=2; ctx.stroke();
      if(aabb(player.x,player.y,player.w,player.h,c.x-10,c.y-10,20,20)){ corn++; cat.lead += 36; coins.splice(i,1); }
      if(c.x<-30) coins.splice(i,1);
    }
    cornEl.textContent=corn;

    // Ø±ÙŠØ´Ø©
    for(let i=feathers.length-1;i>=0;i--){
      const f=feathers[i]; f.x -= world.speed*dt;
      ctx.save(); ctx.translate(f.x,f.y); ctx.rotate(Math.sin((performance.now()/400)+i)*.2);
      ctx.fillStyle="#b4f5ff"; ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(22,-8,28,0); ctx.quadraticCurveTo(22,12,0,10); ctx.closePath(); ctx.fill(); ctx.restore();
      if(aabb(player.x,player.y,player.w,player.h,f.x-16,f.y-10,32,20)){ player.flap=f.time; cat.lead+=24; feathers.splice(i,1); }
      if(f.x<-40) feathers.splice(i,1);
    }

    // Ø±Ø³Ù… Ø§Ù„ÙØ±Ø®Ø© ÙˆØ§Ù„Ù‚Ø· Ù…Ù† Sprites
    chicken.draw(player.x, player.y, player.w, player.h, dt);
    const catX = player.x - cat.lead - (cat.w - player.w)/2;
    catSprite.draw(catX, cat.y, cat.w, cat.h, dt);

    // Ø§Ù‚ØªØ±Ø§Ø¨ Ø§Ù„Ù‚Ø· + Ø´Ø±ÙŠØ·
    cat.lead -= cat.approach*dt; cat.lead = clamp(cat.lead,0,260);
    const p = (cat.lead/260)*100; leadFill.style.width=p.toFixed(1)+'%';
    leadFill.style.background = (p<25)?'linear-gradient(90deg,var(--danger),#ff8d6c)':(p<50)?'linear-gradient(90deg,#ffb020,#ffd166)':'linear-gradient(90deg,var(--ok),var(--accent))';

    if(cat.lead<=0) gameOverScreen("Ø£Ù…Ø³ÙƒÙƒ Ø§Ù„Ù‚Ø·! ğŸ˜¿");
  }

  function loop(ts){ if(!running){ last=ts; requestAnimationFrame(loop); return; } const dt=Math.min(.032,(ts-last)/1000||0); last=ts; if(!paused) update(dt); requestAnimationFrame(loop); }
  function jump(){ if(!running||paused) return; if(player.onGround){player.vy=JUMP_V; player.onGround=false;} }

  window.addEventListener('keydown',e=>{
    if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault(); jump();}
    else if(e.code==='KeyP'){paused=!paused;}
    else if(e.code==='KeyR'){reset();}
  }, {passive:false});
  canvas.addEventListener('pointerdown',()=>jump(),{passive:true});
  startBtn.addEventListener('click', reset);
  function roundRect(x,y,w,h,r,fill,stroke){ if(w<2*r)r=w/2; if(h<2*r)r=h/2; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill)ctx.fill(); if(stroke)ctx.stroke(); }
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
